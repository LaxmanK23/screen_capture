<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>LAN Remote Control — Client (debug)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
        margin: 12px;
      }
      #video {
        max-width: 100%;
        border: 1px solid #ddd;
        cursor: crosshair;
        user-select: none;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        margin: 8px 0;
        flex-wrap: wrap;
      }
      .small {
        font-size: 12px;
        color: #555;
      }
      input[type="text"],
      input[type="password"] {
        padding: 6px 8px;
      }
      button {
        padding: 6px 10px;
      }
      #status {
        padding: 6px 8px;
        border-radius: 6px;
        background: #eee;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <h2>LAN Remote Control — Client (debug)</h2>

    <div class="row">
      <label
        >Server (host:port):
        <input
          id="server"
          type="text"
          placeholder="192.168.1.114:8010"
          value="192.168.1.114:8010"
        />
      </label>
      <label
        >Password:
        <input
          id="password"
          type="password"
          placeholder="password"
          value="change-me"
        />
      </label>
      <button id="connectBtn">Connect</button>
      <label><input id="controlToggle" type="checkbox" /> Enable control</label>
      <div id="status">disconnected</div>
    </div>

    <div class="row small">
      <div>
        Click/drag on the preview when control is enabled. Check devtools
        console for logs.
      </div>
    </div>

    <img id="video" alt="screen preview" />
    <div class="row">
      <input
        id="textInput"
        type="text"
        placeholder="Type here and press Enter..."
        style="width: 320px"
      />
      <button id="enterBtn">Enter</button>
      <button id="escBtn">Esc</button>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      const serverEl = document.getElementById("server");
      const passwordEl = document.getElementById("password");
      const connectBtn = document.getElementById("connectBtn");
      const controlToggle = document.getElementById("controlToggle");
      const imgEl = document.getElementById("video");
      const textInput = document.getElementById("textInput");
      const enterBtn = document.getElementById("enterBtn");
      const escBtn = document.getElementById("escBtn");
      const statusEl = document.getElementById("status");

      let socket = null;
      let serverBase = "";
      let password = "";
      let isAuthorized = false;

      function setStatus(s) {
        statusEl.textContent = s;
        console.log("[STATUS]", s);
      }

      function connect() {
        serverBase = `http://${serverEl.value.replace(/\/+$/, "")}`;
        password = passwordEl.value;
        isAuthorized = false;
        setStatus("connecting...");

        // set preview
        imgEl.src = `${serverBase}/stream?token=${encodeURIComponent(
          password
        )}`;

        // Create socket without forcing websocket — allow fallback to polling if needed
        socket = io(serverBase, {
          transports: ["websocket", "polling"],
          reconnectionAttempts: 3,
          timeout: 5000,
        });

        socket.on("connect", () => {
          console.log("socket connected, id=", socket.id);
          setStatus("connected (socket)");
          // ask server to auth
          socket.emit("auth", { password });
        });

        socket.on("connect_error", (err) => {
          console.error("connect_error", err);
          setStatus("connect_error");
        });

        socket.on("connect_timeout", () => {
          console.warn("connect_timeout");
          setStatus("connect_timeout");
        });

        socket.on("reconnect_attempt", (n) => {
          console.log("reconnect attempt", n);
          setStatus("reconnecting...");
        });

        socket.on("need_auth", () => {
          console.log("server asked for auth");
          setStatus("need_auth");
        });

        socket.on("auth_ok", () => {
          console.log("auth_ok received");
          isAuthorized = true;
          setStatus("authorized");
        });

        socket.on("auth_failed", () => {
          console.warn("auth_failed");
          isAuthorized = false;
          setStatus("auth_failed");
          alert("Auth failed — check password");
        });

        socket.on("disconnect", (reason) => {
          console.log("socket disconnected:", reason);
          isAuthorized = false;
          setStatus("disconnected");
        });

        socket.on("error", (e) => {
          console.error("server error:", e);
        });
      }

      connectBtn.addEventListener("click", connect);

      function coordsToNormalized(evt) {
        const rect = imgEl.getBoundingClientRect();
        const nx = (evt.clientX - rect.left) / rect.width;
        const ny = (evt.clientY - rect.top) / rect.height;
        return {
          nx: Math.max(0, Math.min(1, nx)),
          ny: Math.max(0, Math.min(1, ny)),
        };
      }

      let lastMove = 0;
      imgEl.addEventListener("mousemove", (evt) => {
        if (!controlToggle.checked || !socket || !isAuthorized) return;
        const now = performance.now();
        if (now - lastMove < 40) return; // ~25Hz
        lastMove = now;
        const { nx, ny } = coordsToNormalized(evt);
        socket.emit("mouse_move", { nx, ny });
      });

      imgEl.addEventListener("click", (evt) => {
        if (!controlToggle.checked || !socket || !isAuthorized) return;
        socket.emit("mouse_click", {
          button: evt.button === 2 ? "right" : "left",
          double: false,
        });
      });

      imgEl.addEventListener("dblclick", (evt) => {
        if (!controlToggle.checked || !socket || !isAuthorized) return;
        socket.emit("mouse_click", { button: "left", double: true });
      });

      imgEl.addEventListener("contextmenu", (evt) => {
        if (!controlToggle.checked || !socket || !isAuthorized) return;
        evt.preventDefault();
        socket.emit("mouse_click", { button: "right", double: false });
      });

      imgEl.addEventListener("mousedown", (evt) => {
        if (!controlToggle.checked || !socket || !isAuthorized) return;
        socket.emit("mouse_down", {
          button: evt.button === 2 ? "right" : "left",
        });
      });

      imgEl.addEventListener("mouseup", (evt) => {
        if (!controlToggle.checked || !socket || !isAuthorized) return;
        socket.emit("mouse_up", {
          button: evt.button === 2 ? "right" : "left",
        });
      });

      imgEl.addEventListener(
        "wheel",
        (evt) => {
          if (!controlToggle.checked || !socket || !isAuthorized) return;
          evt.preventDefault();
          const dy = Math.sign(evt.deltaY) * -80;
          const dx = Math.sign(evt.deltaX) * -80;
          socket.emit("mouse_scroll", { dx, dy });
        },
        { passive: false }
      );

      textInput.addEventListener("keydown", (evt) => {
        if (!socket || !isAuthorized) return;
        if (evt.key === "Enter") {
          const text = textInput.value;
          if (text) socket.emit("key_type", { text });
          textInput.value = "";
        }
      });

      enterBtn.addEventListener("click", () => {
        if (socket && isAuthorized) socket.emit("key_press", { key: "enter" });
      });
      escBtn.addEventListener("click", () => {
        if (socket && isAuthorized) socket.emit("key_press", { key: "esc" });
      });
    </script>
  </body>
</html>
